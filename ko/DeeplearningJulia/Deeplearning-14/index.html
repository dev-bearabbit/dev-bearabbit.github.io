

<!DOCTYPE html>
<html lang="ko" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">
  <link rel="alternate" hreflang="ko" href="https://dev-bearabbit.github.io/" />
  <link rel="alternate" hreflang="en" href="https://dev-bearabbit.github.io/en/" />  
  <link rel="apple-touch-icon" sizes="76x76" href="/img/apple-touch-icon.png">
  <link rel="icon" href="/img/favicon.ico">
  

  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#000">
  <meta name="author" content="Jess">
  <meta name="keywords" content="">
  
    <meta name="description" content="해당 시리즈는 프로그래밍 언어 중 하나인 줄리아(Julia)로 딥러닝(Deep learning)을 구현하면서 원리를 설명합니다.">
<meta property="og:type" content="article">
<meta property="og:title" content="14. CNN 시작하기">
<meta property="og:url" content="https://dev-bearabbit.github.io/ko/DeeplearningJulia/Deeplearning-14/index.html">
<meta property="og:site_name" content="DEV AnythinG">
<meta property="og:description" content="해당 시리즈는 프로그래밍 언어 중 하나인 줄리아(Julia)로 딥러닝(Deep learning)을 구현하면서 원리를 설명합니다.">
<meta property="og:locale" content="ko_KR">
<meta property="og:image" content="https://dev-bearabbit.github.io/images/65.png">
<meta property="og:image" content="https://dev-bearabbit.github.io/images/66.png">
<meta property="og:image" content="https://dev-bearabbit.github.io/images/67.png">
<meta property="og:image" content="https://dev-bearabbit.github.io/images/68.png">
<meta property="article:published_time" content="2020-06-20T06:04:49.000Z">
<meta property="article:modified_time" content="2024-12-29T18:34:59.002Z">
<meta property="article:author" content="Jess">
<meta property="article:tag" content="딥러닝">
<meta property="article:tag" content="Deeplearning">
<meta property="article:tag" content="줄리아">
<meta property="article:tag" content="CNN">
<meta property="article:tag" content="합성곱">
<meta property="article:tag" content="이미지신경망">
<meta property="article:tag" content="풀링">
<meta property="article:tag" content="flatten">
<meta property="article:tag" content="convolution">
<meta property="article:tag" content="Julia">
<meta property="article:tag" content="모델">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://dev-bearabbit.github.io/images/65.png">
  
  
  
  <title>14. CNN 시작하기 - DEV AnythinG</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- 主题依赖的图标库，不要自行修改 -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/c/font_1749284_5i9bdhy70f8.css">



<link rel="stylesheet" href="//at.alicdn.com/t/c/font_1736178_k526ubmyhba.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  




  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"dev-bearabbit.github.io","root":"/","version":"1.9.8","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":false,"follow_dnt":true,"baidu":null,"google":{"measurement_id":null},"tencent":{"sid":null,"cid":null},"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false},"umami":{"src":null,"website_id":null,"domains":null,"start_time":"2024-01-01T00:00:00.000Z","token":null,"api_server":null}},"search_path":"/local-search.xml","include_content_in_search":true};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  


  
<meta name="generator" content="Hexo 7.3.0"></head>

<body>
  

  <header>
    

<div class="header-inner" style="height: 70vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>DEV AnythinG</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/" target="_self">
                <i class="iconfont icon-home-fill"></i>
                <span>Home</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/" target="_self">
                <i class="iconfont icon-category-fill"></i>
                <span>Categories</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/" target="_self">
                <i class="iconfont icon-user-fill"></i>
                <span>About</span>
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              <i class="iconfont icon-search"></i>
            </a>
          </li>
          
        
        <li class="nav-item dropdown">
          <a class="nav-link dropdown-toggle" href="javascript:;" id="languageDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
            <i class="iconfont icon-globe"></i> <span id="current-lang"></span>
          </a>
          <div class="dropdown-menu" aria-labelledby="languageDropdown">
            <a class="dropdown-item" href="/">한국어</a>
            <a class="dropdown-item" href="/en/">English</a>
          </div>
        </li>
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">
              <i class="iconfont icon-dark" id="color-toggle-icon"></i>
            </a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    // 현재 언어를 URL 기반으로 감지
    const path = window.location.pathname;
    const currentLang = path.startsWith('/en/') ? 'English' : '한국어';

    // 선택된 언어를 버튼에 표시
    const currentLangElement = document.getElementById('current-lang');
    currentLangElement.textContent = currentLang;
  });
</script>

  

<div id="banner" class="banner" parallax=true
  style="background: url('/img/background.gif') no-repeat center center; background-size: cover;">
  <canvas id="canvas" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%;"></canvas>
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="14. CNN 시작하기"></span>
          
        </div>

        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2020-06-20 15:04" pubdate>
          2020년 6월 20일 오후
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          728 words
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          7 mins
        
      </span>
    

    
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');

    // 캔버스 크기를 배너 크기와 동기화
    const banner = document.getElementById('banner');
    canvas.width = banner.offsetWidth;
    canvas.height = banner.offsetHeight;

    const cols = Math.floor(canvas.width / 20) + 1;
    const ypos = Array(cols).fill(0);

    function matrix() {
      ctx.fillStyle = '#0001'; // 배경 페이드 효과
      ctx.fillRect(0, 0, canvas.width, canvas.height);

      ctx.fillStyle = '#009600'; // 텍스트 색상
      ctx.font = '14pt monospace';

      ypos.forEach((y, index) => {
        const text = String.fromCharCode(33 + Math.random() * 94); // 랜덤 ASCII 문자
        const x = index * 20;
        ctx.fillText(text, x, y);

        if (y > canvas.height + Math.random() * 10000) ypos[index] = 0;
        else ypos[index] = y + 20;
      });
    }

    setInterval(matrix, 60);

    // 창 크기 조정 시 캔버스 크기 업데이트
    window.addEventListener('resize', () => {
      canvas.width = banner.offsetWidth;
      canvas.height = banner.offsetHeight;
    });
  });
</script>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <h1 id="seo-header">14. CNN 시작하기</h1>
            
            
              <div class="markdown-body">
                
                <p>해당 시리즈는 프로그래밍 언어 중 하나인 줄리아(Julia)로 딥러닝(Deep learning)을 구현하면서 원리를 설명합니다. <span id="more"></span></p>
<hr />
<p>지금까지 우리는 다층퍼셉트론(MLP) 기반의 완전연결신경망(Fully Connected network)을 구현하면서 원리를 알아보았다. 하지만 이미지 데이터를 기반으로 신경망을 구현할 때, 완전연결신경망은 이미지 데이터를 일자로 펴서 학습하므로 데이터의 공간적 특성을 이해하기 어렵다. 이를 해결하기 위해 등장한 개념이 바로 합성곱(convolution)이다.</p>
<h2 id="cnn-convolutional-neural-network-이란">CNN (Convolutional Neural Network) 이란</h2>
<p>'합성곱 신경망(CNN, Convolutional Neural Network)'은 3차원의 이미지 데이터를 그대로 입력받아 학습하는 신경망이다. 완전연결신경망과 다른 점은 '합성곱(convolution)'과 '풀링(pooling)'이라는 레이어가 추가된다는 것이다. 따라서 CNN을 이해하기 위해서는 두 레이어의 원리를 알아야 한다.</p>
<h2 id="합성곱-convolution">합성곱 (Convolution)</h2>
<p>합성곱은 하나의 이미지를 여러 조각으로 나누어 각 조각의 특성을 전달하는 방식이다. 아래의 그림은 합성곱의 원리를 보여준다. 참고로 <a target="_blank" rel="noopener" href="https://github.com/Hyeonji-Ryu/Deep_Learning_in_Julia/blob/master/CNN/layers_without_im2col.jl">깃허브</a>에서 줄리아로 구현한 합성곱 코드를 볼 수 있다.</p>
<figure>
<img src="/images/65.png" srcset="/img/loading.gif" lazyload alt="합성곱" /><figcaption aria-hidden="true">합성곱</figcaption>
</figure>
<p>먼저 그림에서 <code>Input_data</code>는 입력된 이미지이고, <code>Filter_1</code> 와 <code>Filter_2</code>는 가중치이다. 합성곱층에서는 가중치 크기에 맞게 조각난 입력데이터들을 곱하여 합한 후 결과값 요소로 반환한다. 위의 예시는 다음과 같은 셋팅이다.</p>
<ul>
<li><p>입력데이터: <span class="math inline">\(5 \times 5 \times 1 \times 1\)</span> 배열인 4차원 데이터이다. 기본적으로 이미지 데이터는 3차원으로 구성되어 있지만, 보통 배치데이터로 훈련하기 때문에 4차원이라고 보는 것이 더 좋다. 줄리아에서 배열의 순서는 <strong>행 <span class="math inline">\(\times\)</span> 열 <span class="math inline">\(\times\)</span> 색(차원) <span class="math inline">\(\times\)</span> 개수</strong> 이다. 여기서 <strong>색(차원)</strong>은 흑백인 경우 <code>1</code>, 컬러인 경우 RGB로 나뉘어 <code>3</code>이 된다.</p></li>
<li><p>가중치(필터): <span class="math inline">\(3 \times 3 \times 1 \times 2\)</span> 배열인 4차원 데이터이다. 가중치는 입력데이터와 곱해진다. 가중치의 배열 순서는 <strong>행 <span class="math inline">\(\times\)</span> 열 <span class="math inline">\(\times\)</span> 색(차원) <span class="math inline">\(\times\)</span> 개수</strong>으로 입력데이터와 동일하다. 참고로 가중치의 개수는 결과값의 차원이 된다.</p></li>
</ul>
<p>입력데이터의 조각들과 가중치를 각각 곱한 후 그 곱들의 합이 결과값의 원소가 된다. 이미지를 조각내는 기준을 스트라이드(stride)라고 하며, 위의 예시는 스트라이드가 1인 경우이다. 또한 합성곱은 입력데이터보다 더 작은 크기의 결과를 반환한다. 결과값 행렬의 크기를 구하는 식은 다음과 같다.</p>
<p><span class="math display">\[\frac{input\ size + 2*padding - filter\ size}{stride} +  1\]</span></p>
<p>위 식을 따라 위의 그림 예시의 값들을 넣어본다면 다음과 같다.</p>
<p><span class="math display">\[ \frac{5 + 0 - 3}{1} + 1 = 3\]</span></p>
<p>참고로 <span class="math inline">\(padding\)</span>은 데이터 크기가 줄어드는 것을 막기 위해서 사용하는 방법이다.</p>
<p><strong>Note</strong> 패딩 (padding) 이란? 패딩은 데이터에 표면에 0을 둘러서 데이터 크기를 키우는 기술을 의미한다. 예를 들어 <span class="math inline">\(2 \times 2\)</span> 행렬이 있고 패딩을 1 추가한다면, 모든 표면에 0이 둘러지면서 <span class="math inline">\(4 \times 4\)</span> 행렬을 반환한다.</p>
<p>결국 입력데이터 <span class="math inline">\(5 \times 5 \times 1 \times 1\)</span> 배열은 가중치 <span class="math inline">\(3 \times 3 \times 1 \times 2\)</span> 배열과 합성곱되어 결과값 <span class="math inline">\(3 \times 3 \times 2 \times 1\)</span> 배열을 도출한다. 이를 모두 정리하면 다음과 같다.</p>
<ul>
<li>입력데이터 형상: <span class="math inline">\(5 \times 5 \times 1 \times 1\)</span></li>
<li>필터 형상: <span class="math inline">\(3 \times 3 \times 1 \times 2\)</span></li>
<li>합성곱 결과 형상: <span class="math inline">\(3 \times 3 \times 2 \times 1\)</span></li>
</ul>
<p>합성곱 결과의 배열 순서는 <strong>행 <span class="math inline">\(\times\)</span> 열 <span class="math inline">\(\times\)</span> 가중치 개수 <span class="math inline">\(\times\)</span> 입력값 개수</strong>이다. 즉, 가중치의 개수가 결과값의 차원이 되는 것이다.</p>
<h2 id="풀링-pooling">풀링 (pooling)</h2>
<p>풀링은 데이터의 크기를 줄여주는 방법이다. 데이터가 큰 경우 파라미터가 기하급수적으로 증가하여 연산 시간이 많이 소요된다. 이를 방지하고자 중간에 풀링 계층을 넣어 데이터의 크기를 줄여준다. 풀링은 크게 '최대값 풀링(Max pooling)'과 '평균 풀링(Average pooling)'이 있다. 보통 최대값 풀링이 많이 사용된다. <a target="_blank" rel="noopener" href="https://github.com/Hyeonji-Ryu/Deep_Learning_in_Julia/blob/master/CNN/layers_without_im2col.jl">깃허브</a>에서 줄리아로 구현한 풀링 코드를 볼 수 있다.</p>
<h3 id="최대값-풀링-max-pooling">최대값 풀링 (Max pooling)</h3>
<p>최대값 풀링의 원리를 그림으로 나타내면 다음과 같다.</p>
<figure>
<img src="/images/66.png" srcset="/img/loading.gif" lazyload alt="최대 풀링" /><figcaption aria-hidden="true">최대 풀링</figcaption>
</figure>
<p>풀링에서는 합성곱과 달리 필터가 필요하지 않다. 다만, 풀링의 범위를 정해야 한다. 위의 그림에서는 <span class="math inline">\(2 \times 2\)</span> 크기로 풀링을 진행하며, 해당 범위에서 최대값을 반환하는 것이 최대값 풀링이다.</p>
<h3 id="평균-풀링-average-pooling">평균 풀링 (Average pooling)</h3>
<p>평균 풀링은 풀링 크기의 요소들의 평균을 결과값으로 반환한다. 그림으로는 다음과 같다.</p>
<figure>
<img src="/images/67.png" srcset="/img/loading.gif" lazyload alt="평균 풀링" /><figcaption aria-hidden="true">평균 풀링</figcaption>
</figure>
<h2 id="simple-cnn-구현">Simple CNN 구현</h2>
<p>지금까지 합성곱층과 풀링층의 원리에 대해서 알아보았다. 이제 실제 코드로 구현하여 신경망을 학습해보자.</p>
<h3 id="준비-단계">준비 단계</h3>
<p>먼저 <a target="_blank" rel="noopener" href="https://github.com/Hyeonji-Ryu/Deep_Learning_in_Julia">깃허브</a>에 들어가서 해당 <code>clone</code>이나 <code>Download zip</code>을 하여 코드들을 저장해야 한다. 만약 이에 대해 잘 모르거나 어려운 사람들은 <a target="_blank" rel="noopener" href="https://github.com/Hyeonji-Ryu/Deep_Learning_in_Julia/tree/master/CNN">해당 페이지</a>에서 코드를 직접 복사해서 입력할 수도 있다.</p>
<p>깃허브 데스크탑에 코드를 클론하거나 저장한 분들은 현재 사용하고 있는 커맨드의 경로를 <code>CNN</code> 파일로 변경해야 한다.</p>
<figure class="highlight julia"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs Julia">pwd <span class="hljs-comment"># 현재 경로 확인</span><br>cd 코드가 있는 파일 경로 입력/Machine_Learning_in_Julia/CNN<br></code></pre></td></tr></table></figure>
<p>다시 <code>pwd</code>를 입력했을 때 아래와 같이 변경되어 있으면 변경이 완료된 것이다.</p>
<figure class="highlight julia"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs Julia">/Users/코드가 있는 파일 경로/Machine_Learning_in_Julia/CNN<br></code></pre></td></tr></table></figure>
<p>변경이 완료된 후 아래의 코드를 입력하자.</p>
<figure class="highlight julia"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs Julia">include(<span class="hljs-string">&quot;MNIST_data.jl&quot;</span>)<br>include(<span class="hljs-string">&quot;functions.jl&quot;</span>)<br>include(<span class="hljs-string">&quot;layers_without_im2col.jl&quot;</span>)<br>include(<span class="hljs-string">&quot;making_network.jl&quot;</span>)<br>include(<span class="hljs-string">&quot;optimizers.jl&quot;</span>)<br></code></pre></td></tr></table></figure>
<p>위 코드는 파일에 들어 있는 모든 코드들을 작동시킨다. 만약 코드를 복사하여 사용할 분들은 <a target="_blank" rel="noopener" href="https://github.com/Hyeonji-Ryu/Deep_Learning_in_Julia/tree/master/CNN">해당 페이지</a>에서 위의 파일들의 코드를 복사하여 입력해주면 된다.</p>
<p>이제 간단한 CNN 모델을 만들 준비가 끝났다.</p>
<h3 id="모델-설계">모델 설계</h3>
<p>합성곱 신경망 1층과 완견연결 신경망 2층을 사용하여 모델을 구성하고자 한다. 모델의 순서는 다음과 같다.</p>
<figure>
<img src="/images/68.png" srcset="/img/loading.gif" lazyload alt="simple CNN" /><figcaption aria-hidden="true">simple CNN</figcaption>
</figure>
<p>위 모델은 책 '밑바닥부터 시작하는 딥러닝'에서 예제로 사용한 것이다. 매우 간단하지만 <code>MNIST</code> 데이터를 학습하는 데 문제가 없다. 이제 모델 층에 알맞은 <code>predict()</code>를 정의해야 한다.</p>
<figure class="highlight julia"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs Julia"><span class="hljs-keyword">function</span>  predict(input)<br><br>    pconv_1 = conv2D_forward_batch(pre_dense, input, params[<span class="hljs-string">&quot;W1&quot;</span>], params[<span class="hljs-string">&quot;b1&quot;</span>],<span class="hljs-number">1</span>)<br>    pconv_Re = relu.(pconv_1)<br>    ppool_1 = maxpooling2D_forward_batch(pre_pool,pconv_Re, <span class="hljs-number">2</span>, <span class="hljs-number">2</span>)<br>    flatten_1 = flatten_forward_batch(pre_flatten,ppool_1)<br>    dense_1 = (flatten_1 * params[<span class="hljs-string">&quot;W2&quot;</span>]) .+ params[<span class="hljs-string">&quot;b2&quot;</span>]<br>    dense_relu = relu.(dense_1)<br>    dense_2 = (dense_relu * params[<span class="hljs-string">&quot;W3&quot;</span>]) .+ params[<span class="hljs-string">&quot;b3&quot;</span>]<br>    result = softmax(dense_2)<br><span class="hljs-keyword">end</span><br></code></pre></td></tr></table></figure>
<h3 id="학습-구현">학습 구현</h3>
<p><code>loss()</code>에 사용되는 예측 함수를 설정한 후에 파라미터인 가중치와 편향 초기값도 설정한다.</p>
<figure class="highlight julia"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs Julia">W =[<span class="hljs-string">&quot;W1&quot;</span>,<span class="hljs-string">&quot;W2&quot;</span>,<span class="hljs-string">&quot;W3&quot;</span>]<br>b = [<span class="hljs-string">&quot;b1&quot;</span>,<span class="hljs-string">&quot;b2&quot;</span>,<span class="hljs-string">&quot;b3&quot;</span>]<br>weight_size = [(<span class="hljs-number">5</span>,<span class="hljs-number">5</span>,<span class="hljs-number">1</span>,<span class="hljs-number">30</span>),(<span class="hljs-number">4320</span>,<span class="hljs-number">100</span>),(<span class="hljs-number">100</span>,<span class="hljs-number">10</span>)];<br>input_size = (<span class="hljs-number">28</span>,<span class="hljs-number">28</span>,<span class="hljs-number">1</span>)<br><br>params = making_network(W, b, weight_size,input_size,<span class="hljs-string">&quot;std&quot;</span>);<br></code></pre></td></tr></table></figure>
<p>초기값은 기본값으로 사용하는 <code>std</code>로 설정하였다. 초기값에 대해서는 <a href="https://dev-bearabbit.github.io/2020/05/15/DeeplearningJulia/Deeplearning-12/">인공신경망 최적화 - 가충치 초기값</a>에서 더 자세히 알 수 있다.</p>
<p>파라미터를 만들었다면, 이제 모델에서 필요한 값들을 저장할 저장소를 생성한다.</p>
<figure class="highlight julia"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs Julia"><span class="hljs-comment"># predict()용 저장소</span><br>pre_dense = dense_layer(<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>)<br>pre_pool= repository(<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>)<br>pre_flatten = repository(<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>)<br><br><br><span class="hljs-comment"># 실제 저장소</span><br>result = SoftmaxwithLoss(<span class="hljs-number">0</span>,<span class="hljs-number">0</span>)<br>dense1 = dense_layer(<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>)<br>dense2 = dense_layer(<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>)<br>dense3 = dense_layer(<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>)<br>Relu1 = repository(<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>)<br>Relu2 = repository(<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>)<br>optimizer = optimizers(<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>)<br>pool1= repository(<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>)<br>flatten1 = repository(<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>)<br></code></pre></td></tr></table></figure>
<p><code>pre</code>라고 붙은 저장소는 모델에 사용되는 함수의 파라미터 개수를 맞춰주기 위해 만든 것이다. 사실상 모델에 필요한 값을 저장하는 저장소는 아니다. 다음으로는 로스값과 미분값을 저장할 리스트와 딕셔너리를 정의한다.</p>
<figure class="highlight julia"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs Julia">grads = <span class="hljs-built_in">Dict</span>()<br>train_loss_list= []<br></code></pre></td></tr></table></figure>
<p>이제 모델을 작동시켜보자. 해당 모델의 구성은 다음과 같다.</p>
<ul>
<li>Algorithm: backpropagation</li>
<li>Optimizer: Adam</li>
<li>batch_size: 100</li>
<li>one_epoch: 600</li>
</ul>
<figure class="highlight julia"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><code class="hljs Julia"><span class="hljs-meta">@time</span> <span class="hljs-keyword">begin</span><br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-number">1</span>:<span class="hljs-number">600</span><br><br>        batch_size = rand(<span class="hljs-number">1</span>:size(train_x)[<span class="hljs-number">4</span>],<span class="hljs-number">100</span>)<br>        train_x_batch = train_x[:,:,:,batch_size]<br>        t_batch = reshape(t[batch_size,:],<span class="hljs-number">100</span>,<span class="hljs-number">10</span>)<br><br>        <span class="hljs-comment">#신경망 계산</span><br>        conv_1 = conv2D_forward_batch(dense1,train_x_batch,params[<span class="hljs-string">&quot;W1&quot;</span>],params[<span class="hljs-string">&quot;b1&quot;</span>],<span class="hljs-number">1</span>)<br>        conv_Re = relu_forward(Relu1, conv_1)<br>        pool_1 = maxpooling2D_forward_batch(pool1, conv_Re, <span class="hljs-number">2</span>, <span class="hljs-number">2</span>)<br>        flatten_1 = flatten_forward_batch(flatten1, pool_1)<br>        dense_1 = dense_layer_forward(dense2,flatten_1,params[<span class="hljs-string">&quot;W2&quot;</span>],params[<span class="hljs-string">&quot;b2&quot;</span>])<br>        dense_relu = relu_forward(Relu2, dense_1)<br>        dense_2 = dense_layer_forward(dense3,dense_relu,params[<span class="hljs-string">&quot;W3&quot;</span>],params[<span class="hljs-string">&quot;b3&quot;</span>])<br>        num = SoftmaxwithLoss_forward(dense_2,t_batch)<br><br>        <span class="hljs-comment">#역전파 알고리즘</span><br>        last_layer = SoftmaxwithLoss_backward(result)<br>        dense_2_back = dense_layer_backward(dense3, last_layer)<br>        grads[<span class="hljs-string">&quot;W3&quot;</span>] = dense3.dw<br>        grads[<span class="hljs-string">&quot;b3&quot;</span>] = dense3.db<br>        dense_relu_back = relu_backward(Relu2, dense_2_back)<br>        dense_1_back = dense_layer_backward(dense2, dense_relu_back)<br>        grads[<span class="hljs-string">&quot;W2&quot;</span>] = dense2.dw<br>        grads[<span class="hljs-string">&quot;b2&quot;</span>] = dense2.db<br>        flatten_1_back = flatten_backward_batch(flatten1,dense_1_back)<br>        pool_1_back = maxpooling2D_backward_batch(pool1, flatten_1_back, <span class="hljs-number">2</span>, <span class="hljs-number">2</span>)<br>        conv_Re_back = relu_backward(Relu1, pool_1_back)<br>        conv_back = conv2D_backward_batch(dense1,conv_Re_back)<br>        grads[<span class="hljs-string">&quot;W1&quot;</span>] = dense1.dw<br>        grads[<span class="hljs-string">&quot;b1&quot;</span>] = dense1.db<br><br>        <span class="hljs-comment">#가중치 갱신</span><br>        Adam(params,grads)<br><br>        temp_loss = loss_CNN_batch(train_x_batch,t_batch)<br>        print(<span class="hljs-string">&quot;NO.<span class="hljs-variable">$i</span>: &quot;</span>)<br>        println(temp_loss)<br>        append!(train_loss_list, temp_loss)<br>    <span class="hljs-keyword">end</span><br><span class="hljs-keyword">end</span><br></code></pre></td></tr></table></figure>
<p>위 모델의 정확도는 다음과 같다.</p>
<figure class="highlight julia"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs Julia"><span class="hljs-comment"># 1에폭: 96.8</span><br><span class="hljs-comment"># 2에폭: 97.73</span><br><span class="hljs-comment"># 3에폭: 98.35</span><br><span class="hljs-comment"># 4에폭: 98.39</span><br><span class="hljs-comment"># 5에폭: 98.50999999999999</span><br></code></pre></td></tr></table></figure>
<p>확실히 MLP보다 학습이 잘 된다는 것을 확인할 수 있다.</p>
<h2 id="결론">결론</h2>
<p>위 코드는 1에폭(600)에 1시간 정도 소요된다. 이전까지 배웠던 MLP 모델을 작동시켜봤다면 '이 모델이 역전파를 사용한 것이 맞는가?' 라는 의문이 들 수 있다. 사실 위 모델에 사용된 방식의 합성곱층과 풀링층은 이론적으로는 맞지만, 아무도 사용하지 않는다. 그 이유는 너무 느려서이다. 4차원 데이터를 가공하지 않고 인덱스를 잡아 함수를 실행하는 것은 컴퓨터의 입장에서 엄청난 노동이다. 그래서 우리는 기술적으로 4차원 데이터를 2차원으로 변환한 뒤, 계산을 하고 다시 4차원으로 조립하는 과정을 사용한다. 이 방법은 아~~주 느린 합성곱층과 풀링층을 훨씬 빠르게 작동하게 만들어준다.</p>
<p>만약 위 코드를 1에폭이라도 돌려봤다면 그 필요성을 실감할 것이기에, 한 번쯤 돌려보기를 권장한다. 앞서 설명했던 차원을 변경해주는 함수는 일반적으로 동일한 이름으로 쓰인다. 순방향에서는 <code>im2col()</code>, 역방향에서는 <code>col2im()</code>이다. 의미는 이미지에서 행렬로, 또 행렬에서 이미지로 변경해준다는 의미이다. 즉, 4차원 데이터를 2차원으로, 2차원 데이터를 4차원으로 변경해준다는 의미와 동일하다.</p>
<p>다음 글에서는 <code>im2col()</code>과 <code>col2im()</code>의 원리를 설명하고, 줄리아로 구현해볼 것이다. 또한 이를 바탕으로 합성곱층과 풀링층의 함수를 구현할 것이다.</p>

                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
    <div class="post-meta mr-3 d-flex align-items-center">
      <i class="iconfont icon-category"></i>
      

<span class="category-chains">
  
  
    
      <span class="category-chain">
        
  <a href="/categories/machinelearning/" class="category-chain-item">MachineLearning</a>
  
  
    <span>></span>
    
  <a href="/categories/machinelearning/deeplearning/" class="category-chain-item">deeplearning</a>
  
  

  

      </span>
    
  
</span>

    </div>
  
  
    <div class="post-meta">
      <i class="iconfont icon-tags"></i>
      
        <a href="/tags/%EB%94%A5%EB%9F%AC%EB%8B%9D/" class="print-no-link">#딥러닝</a>
      
        <a href="/tags/deeplearning/" class="print-no-link">#Deeplearning</a>
      
        <a href="/tags/%EC%A4%84%EB%A6%AC%EC%95%84/" class="print-no-link">#줄리아</a>
      
        <a href="/tags/cnn/" class="print-no-link">#CNN</a>
      
        <a href="/tags/%ED%95%A9%EC%84%B1%EA%B3%B1/" class="print-no-link">#합성곱</a>
      
        <a href="/tags/%EC%9D%B4%EB%AF%B8%EC%A7%80%EC%8B%A0%EA%B2%BD%EB%A7%9D/" class="print-no-link">#이미지신경망</a>
      
        <a href="/tags/%ED%92%80%EB%A7%81/" class="print-no-link">#풀링</a>
      
        <a href="/tags/flatten/" class="print-no-link">#flatten</a>
      
        <a href="/tags/convolution/" class="print-no-link">#convolution</a>
      
        <a href="/tags/julia/" class="print-no-link">#Julia</a>
      
        <a href="/tags/%EB%AA%A8%EB%8D%B8/" class="print-no-link">#모델</a>
      
    </div>
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>14. CNN 시작하기</div>
      <div>https://dev-bearabbit.github.io/ko/DeeplearningJulia/Deeplearning-14/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>Author</div>
          <div>Jess</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>Posted on</div>
          <div>2020년 6월 20일</div>
        </div>
      
      
      
        <div class="license-meta-item">
          <div>Licensed under</div>
          <div>
            
              
              
                <a class="print-no-link" target="_blank" href="https://creativecommons.org/licenses/by/4.0/">
                  <span class="hint--top hint--rounded" aria-label="BY - Attribution">
                    <i class="iconfont icon-cc-by"></i>
                  </span>
                </a>
              
            
          </div>
        </div>
      
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/ko/DeeplearningJulia/Deeplearning-15/" title="15. im2col의 원리">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">15. im2col의 원리</span>
                        <span class="visible-mobile">Previous</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/ko/DeeplearningJulia/Deeplearning-13/" title="13. 인공신경망 최적화 - 드랍아웃(Dropout)">
                        <span class="hidden-mobile">13. 인공신경망 최적화 - 드랍아웃(Dropout)</span>
                        <span class="visible-mobile">Next</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header">
    <i class="iconfont icon-list"></i>
    <span>Table of Contents</span>
  </p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  


  
  









    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">Search</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">Keyword</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://dev-bearabbit.github.io" target="_blank" rel="nofollow noopener"><span>Jess</span></a>
    </div>
  
  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.4/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.20.1/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init(Object.assign({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      scrollSmooth    : true,
      includeTitleTags: true,
      headingsOffset  : -boardTop,
    }, CONFIG.toc));
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }

    Fluid.events.registerRefreshCallback(function() {
      if ('tocbot' in window) {
        tocbot.refresh();
        var toc = jQuery('#toc');
        if (toc.length === 0 || !tocbot) {
          return;
        }
        if (toc.find('.toc-list-item').length > 0) {
          toc.css('visibility', 'visible');
        }
      }
    });
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/5.0.0/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));

    Fluid.events.registerRefreshCallback(function() {
      if ('anchors' in window) {
        anchors.removeAll();
        var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
        var res = [];
        for (var item of el) {
          res.push('.markdown-body > ' + item.trim());
        }
        if (CONFIG.anchorjs.placement === 'left') {
          anchors.options.class = 'anchorjs-link-left';
        }
        anchors.add(res.join(', '));
      }
    });
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  
      <script>
        if (!window.MathJax) {
          window.MathJax = {
            tex    : {
              inlineMath: { '[+]': [['$', '$']] }
            },
            loader : {
              load: ['ui/lazy']
            },
            options: {
              renderActions: {
                insertedScript: [200, () => {
                  document.querySelectorAll('mjx-container').forEach(node => {
                    let target = node.parentNode;
                    if (target.nodeName.toLowerCase() === 'li') {
                      target.parentNode.classList.add('has-jax');
                    }
                  });
                }, '', false]
              }
            }
          };
        } else {
          MathJax.startup.document.state(0);
          MathJax.texReset();
          MathJax.typeset();
          MathJax.typesetPromise();
        }

        Fluid.events.registerRefreshCallback(function() {
          if ('MathJax' in window && MathJax.startup.document && typeof MathJax.startup.document.state === 'function') {
            MathJax.startup.document.state(0);
            MathJax.texReset();
            MathJax.typeset();
            MathJax.typesetPromise();
          }
        });
      </script>
    

  <script  src="https://lib.baomitu.com/mathjax/3.2.2/es5/tex-mml-chtml.js" ></script>

  <script  src="/js/local-search.js" ></script>





<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">Blog works best with JavaScript enabled</div>
  </noscript>
</body>
</html>
